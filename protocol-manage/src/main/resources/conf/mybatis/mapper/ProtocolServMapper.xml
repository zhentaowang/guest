<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhiweicloud.protocolmanage.mapper.ProtocolServMapper">
  <resultMap id="BaseResultMap" type="com.zhiweicloud.protocolmanage.model.ProtocolServ">
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="airport_code" jdbcType="VARCHAR" property="airportCode" />
    <result column="protocol_id" jdbcType="BIGINT" property="protocolId" />
    <result column="service_id" jdbcType="BIGINT" property="serviceId" />
    <result column="product_type_allocation_id" jdbcType="BIGINT" property="productTypeAllocationId" />
    <result column="price" jdbcType="DECIMAL" property="price" />
      <result column="over_staff_unit_price" jdbcType="DECIMAL" property="overStaffUnitPrice" />
      <result column="free_retinue_num" jdbcType="BIGINT" property="freeRetinueNum" />
    <result column="description" jdbcType="VARCHAR" property="description" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="is_deleted" jdbcType="SMALLINT" property="isDeleted" />
  </resultMap>

  <resultMap id="BaseResultMapPage" type="com.zhiweicloud.protocolmanage.model.ProtocolServ">
    <id column="id" jdbcType="BIGINT" property="id" />
    <result column="airport_code" jdbcType="VARCHAR" property="airportCode" />
    <result column="protocol_id" jdbcType="BIGINT" property="protocolId" />
    <result column="service_id" jdbcType="BIGINT" property="serviceId" />
    <result column="product_type_allocation_id" jdbcType="BIGINT" property="productTypeAllocationId" />
    <result column="price" jdbcType="DECIMAL" property="price" />
      <result column="over_staff_unit_price" jdbcType="DECIMAL" property="overStaffUnitPrice" />
      <result column="free_retinue_num" jdbcType="BIGINT" property="freeRetinueNum" />
    <result column="description" jdbcType="VARCHAR" property="description" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="is_deleted" jdbcType="SMALLINT" property="isDeleted" />
      <result column="service_name" jdbcType="VARCHAR" property="serviceName" />
      <result column="product_category" jdbcType="VARCHAR" property="productCategory" />
      <result column="service_type" jdbcType="VARCHAR" property="serviceType" />
  </resultMap>

  <sql id="Base_Column_List">
    id, airport_code, protocol_id, service_id, product_type_allocation_id, price, over_staff_unit_price, free_retinue_num, description,
    create_time, update_time, is_deleted
  </sql>

  <select id="getListByConidition" parameterType="com.zhiweicloud.guest.pageUtil.BasePagination" resultMap="BaseResultMapPage">
    select
    pss.id,pss.protocol_id,p.airport_code,p.product_category,p.service_type,pss.name as service_name,pss.price,pss.description,pss.over_staff_unit_price,pss.free_retinue_num
    from (
        select ps.*,s.name
             from protocol_serv as ps
        left join serv s on ps.service_id = s.id
        where s.airport_code = #{criteria.airportCode,jdbcType=VARCHAR}
        <if test="criteria.protocolId != null" >
             and ps.protocol_id = #{criteria.protocolId,jdbcType=BIGINT}
        </if>
      <if test="criteria.productTypeAllocationId != null" >
          and ps.product_type_allocation_id = #{criteria.productTypeAllocationId,jdbcType=BIGINT}
      </if>
        and s.is_deleted = 0 and ps.is_deleted = 0
    ) as pss
    left join product_type_allocation p on pss.product_type_allocation_id = p.id
    where p.airport_code = #{criteria.airportCode,jdbcType=VARCHAR} and p.is_deleted = 0
      <if test="criteria.productTypeAllocationId != null" >
          and pss.product_type_allocation_id = #{criteria.productTypeAllocationId,jdbcType=BIGINT}
      </if>
      <if test="criteria.price != null" >
          and pss.price = #{criteria.price,jdbcType=DECIMAL}
      </if>
      <if test="criteria.description != null" >
          and pss.description = #{criteria.description,jdbcType=VARCHAR}
      </if>
      <if test="criteria.overStaffUnitPrice != null" >
          and pss.over_staff_unit_price = #{criteria.overStaffUnitPrice,jdbcType=DECIMAL}
      </if>
      <if test="criteria.freeRetinueNum != null" >
          and pss.free_retinue_num = #{criteria.freeRetinueNum,jdbcType=BIGINT}
      </if>
    order by pss.id desc
    LIMIT #{page.startPageNo},#{page.pCount}
  </select>

    <select id="getProtocolServType" parameterType="com.zhiweicloud.guest.pageUtil.BasePagination" resultMap="BaseResultMapPage">
        select
        pss.id,pss.service_id,pss.protocol_id,pss.product_type_allocation_id,p.airport_code,p.product_category,p.service_type,pss.name as service_name,pss.price,pss.description,pss.over_staff_unit_price,pss.free_retinue_num
        from (
        select ps.*,s.name
        from protocol_serv as ps
        left join serv s on ps.service_id = s.id
        where s.airport_code = #{criteria.airportCode,jdbcType=VARCHAR}
        <if test="criteria.protocolId != null" >
            and ps.protocol_id = #{criteria.protocolId,jdbcType=BIGINT}
        </if>
        <if test="criteria.serviceId != null" >
            and ps.service_id = #{criteria.serviceId,jdbcType=BIGINT}
        </if>
        and s.is_deleted = 0 and ps.is_deleted = 0
        ) as pss
        left join product_type_allocation p on pss.product_type_allocation_id = p.id
        where p.airport_code = #{criteria.airportCode,jdbcType=VARCHAR} and p.is_deleted = 0
        group by p.product_category,p.service_type,pss.description
        order by pss.id desc
        LIMIT #{page.startPageNo},#{page.pCount}
    </select>

    <select id="getTypeCount" parameterType="map" resultType="int">
        select count(mm.id) from(
        select
        pss.id,pss.service_id,pss.protocol_id,p.airport_code,p.product_category,p.service_type,pss.name as service_name,pss.price,pss.description,pss.over_staff_unit_price,pss.free_retinue_num
        from (
        select ps.*,s.name
        from protocol_serv as ps
        left join serv s on ps.service_id = s.id
        where s.airport_code = #{airportCode,jdbcType=VARCHAR}
        <if test="protocolId != null" >
            and ps.protocol_id = #{protocolId,jdbcType=BIGINT}
        </if>
        <if test="serviceId != null" >
            and ps.service_id = #{serviceId,jdbcType=BIGINT}
        </if>
        and s.is_deleted = 0 and ps.is_deleted = 0
        ) as pss
        left join product_type_allocation p on pss.product_type_allocation_id = p.id
        where p.airport_code = #{airportCode,jdbcType=VARCHAR} and p.is_deleted = 0
        group by p.product_category,p.service_type,pss.description) as mm
    </select>

  <select id="getListCount" parameterType="map" resultType="int">
    select
    count(pss.id)
    from (
        select ps.*,s.name
        from protocol_serv as ps
        left join serv s on ps.service_id = s.id
        where s.airport_code = #{airportCode,jdbcType=VARCHAR}
        <if test="protocolId != null">
            and ps.protocol_id = #{protocolId,jdbcType=BIGINT}
        </if>
      <if test="productTypeAllocationId != null" >
          and ps.product_type_allocation_id = #{productTypeAllocationId,jdbcType=BIGINT}
      </if>
        and s.is_deleted = 0
    ) as pss
    left join product_type_allocation p on pss.product_type_allocation_id = p.id
    where p.airport_code = #{airportCode,jdbcType=VARCHAR} and p.is_deleted = 0
      <if test="productTypeAllocationId != null" >
          and pss.product_type_allocation_id = #{productTypeAllocationId,jdbcType=BIGINT}
      </if>
      <if test="price != null" >
          and pss.price = #{price,jdbcType=DECIMAL}
      </if>
      <if test="description != null" >
          and pss.description = #{description,jdbcType=VARCHAR}
      </if>
      <if test="overStaffUnitPrice != null" >
          and pss.over_staff_unit_price = #{overStaffUnitPrice,jdbcType=DECIMAL}
      </if>
      <if test="freeRetinueNum != null" >
          and pss.free_retinue_num = #{freeRetinueNum,jdbcType=BIGINT}
      </if>
  </select>

    <update id="updateByIdAndAirportCode" parameterType="com.zhiweicloud.protocolmanage.model.ProtocolServ">
        <!--
          WARNING - @mbggenerated
          This element is automatically generated by MyBatis Generator, do not modify.
        -->
        update protocol_serv
        <set>
            <if test="price != null">
                price = #{price,jdbcType=DECIMAL},
            </if>
            <if test="overStaffUnitPrice != null">
                over_staff_unit_price = #{overStaffUnitPrice,jdbcType=DECIMAL},
            </if>
            <if test="freeRetinueNum != null">
                free_retinue_num = #{freeRetinueNum,jdbcType=BIGINT},
            </if>
            <if test="description != null">
                description = #{description,jdbcType=VARCHAR},
            </if>
            <if test="isDeleted != null">
                is_deleted = #{isDeleted,jdbcType=SMALLINT},
            </if>
            update_time = CURRENT_TIMESTAMP
        </set>
        where airport_code = #{airportCode,jdbcType=VARCHAR}
        <if test="protocolId != null">
            and protocol_id = #{protocolId,jdbcType=BIGINT}
        </if>
        <if test="id != null">
            and id = #{id,jdbcType=BIGINT}
        </if>
    </update>

    <select id="selectById" parameterType="map" resultMap="BaseResultMapPage">
        select
        p.product_category,p.service_type,pss.name as service_name,pss.price,pss.description,pss.protocol_id,pss.over_staff_unit_price,pss.free_retinue_num
        from (
        select ps.*,s.name
        from protocol_serv as ps
        left join serv s on ps.service_id = s.id
        where s.airport_code = #{airportCode,jdbcType=VARCHAR}
        and ps.id = #{id,jdbcType=BIGINT}
        and s.is_deleted = 0 and ps.is_deleted = 0
        ) as pss
        left join product_type_allocation p on pss.product_type_allocation_id = p.id
        where p.airport_code = #{airportCode,jdbcType=VARCHAR} and p.is_deleted = 0
    </select>

    <select id="deleteByIdAndAirportCode" parameterType="map">
        update protocol_serv set is_deleted = 1 where id not in (${ids00}) and airport_code = #{airportCode,jdbcType=VARCHAR} and protocol_id = #{protocolId,jdbcType=BIGINT}
    </select>

    <select id="deleteByType" parameterType="map">
        update protocol_serv set is_deleted = 1 where airport_code = #{airportCode,jdbcType=VARCHAR} and product_type_allocation_id = #{productTypeAllocationId,jdbcType=BIGINT}
        and protocol_id = #{protocolId,jdbcType=BIGINT}
        <if test="price != 'null' and price!= null" >
            and price = #{price,jdbcType=DECIMAL}
        </if>
        <if test="description != 'null' and description!= null" >
            and description = #{description,jdbcType=VARCHAR}
        </if>
        <if test="overStaffUnitPrice != 'null' and overStaffUnitPrice!= null" >
            and over_staff_unit_price = #{overStaffUnitPrice,jdbcType=DECIMAL}
        </if>
        <if test="freeRetinueNum != 'null' and freeRetinueNum != null" >
            and free_retinue_num = #{freeRetinueNum,jdbcType=BIGINT}
        </if>
    </select>

</mapper>