<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.zhiweicloud.guest.mapper.CheckMapper">


  <select id="selectCheckTotal" parameterType="com.zhiweicloud.guest.model.CheckQueryParam" resultType="int">
    select count(DISTINCT(customer_id)) from order_info o
    inner join flight f on o.flight_id = f.flight_id

    and  o.is_deleted = 0 and f.is_deleted = 0
    <if test="queryFlightDateBegin != null and !''.equals(queryFlightDateBegin)">
      and f.flight_date &gt; #{queryFlightDateBegin}
    </if>
    <if test="queryFlightDateEnd != null and !''.equals(queryFlightDateEnd)">
      and f.flight_date &lt; #{queryFlightDateEnd}
    </if>
    <if test="queryCreateDateBegin != null and !''.equals(queryCreateDateBegin)">
      and o.create_time &gt; #{queryCreateDateBegin}
    </if>
    <if test="queryCreateDateEnd != null and !''.equals(queryCreateDateEnd)">
      and o.create_time &lt; #{queryCreateDateEnd}
    </if>
    <if test="queryCustomerName != null and !''.equals(queryCustomerName)">
      and o.customer_name like concat('%',#{queryCustomerName},'%')
    </if>
    <if test="queryProtocolName != null and !''.equals(queryProtocolName)">
      and o.protocol_name like concat('%',#{queryProtocolName},'%')
    </if>
    <if test="queryProtocolId != null and !''.equals(queryProtocolId)">
      and o.protocol_id in (#{criteria.queryProtocolId})
    </if>
    <if test="queryProductId != null and !''.equals(queryProductId)">
      and o.product_id in (#{queryProductId})
    </if>
  </select>

  <select id="selectCheckList" parameterType="com.zhiweicloud.guest.pageUtil.BasePagination" resultType="map">
    select count(order_id) as orderCount,o.customer_name as customerName,o.protocol_name as protocolName,o.product_name as productName
    from order_info o
    inner join flight f on o.flight_id = f.flight_id

    where o.is_deleted = 0 and f.is_deleted = 0
    <if test="criteria.queryFlightDateBegin != null and !''.equals(criteria.queryFlightDateBegin)">
      and f.flight_date &gt; #{criteria.queryFlightDateBegin}
    </if>
    <if test="criteria.queryFlightDateEnd != null and !''.equals(criteria.queryFlightDateEnd)">
      and f.flight_date &lt; #{criteria.queryFlightDateEnd}
    </if>
    <if test="criteria.queryCreateDateBegin != null and !''.equals(criteria.queryCreateDateBegin)">
      and o.create_time &gt; #{criteria.queryCreateDateBegin}
    </if>
    <if test="criteria.queryCreateDateEnd != null and !''.equals(criteria.queryCreateDateEnd)">
      and o.create_time &lt; #{criteria.queryCreateDateEnd}
    </if>
    <if test="criteria.queryCustomerName != null and !''.equals(criteria.queryCustomerName)">
      and o.customer_name like concat('%',#{criteria.queryCustomerName},'%')
    </if>
    <if test="criteria.queryProtocolName != null and !''.equals(criteria.queryProtocolName)">
      and o.protocol_name like concat('%',#{criteria.queryProtocolName},'%')
    </if>
    <if test="criteria.queryProtocolId != null and !''.equals(criteria.queryProtocolId)">
      and o.protocol_id in (#{criteria.queryProtocolId})
    </if>
    <if test="criteria.queryProductId != null and !''.equals(criteria.queryProductId)">
      and o.product_id in (#{criteria.queryProductId})
    </if>
    GROUP BY o.customer_id
    limit #{page.startPageNo},#{page.pCount}
  </select>


  <resultMap id="OrderCheckDetailMap" type="com.zhiweicloud.guest.model.OrderCheckDetail">
    <result column="order_no" jdbcType="VARCHAR" property="orderNo" />
    <result column="customer_id" jdbcType="BIGINT" property="customerId" />
    <result column="protocol_id" jdbcType="BIGINT" property="protocolId" />
    <result column="product_id" jdbcType="BIGINT" property="productId" />
    <result column="flight_date" jdbcType="TIMESTAMP" property="flightDate" />
    <result column="plan_no" jdbcType="VARCHAR" property="planNo" />
    <result column="flight_dep_airport" jdbcType="VARCHAR" property="flightDepAirport" />
    <result column="flight_arr_airport" jdbcType="VARCHAR" property="flightArrAirport" />
    <result column="is_in_or_out" jdbcType="SMALLINT" property="isInOrOut" />
    <result column="vip_person_num" jdbcType="INTEGER" property="vipPersonNum" />
    <result column="vip_price" jdbcType="DOUBLE" property="vipPrice" />
    <result column="accompany_person_num" jdbcType="INTEGER" property="accompanyPersonNum" />
    <result column="accompany_price" jdbcType="DOUBLE" property="accompanyPrice" />
  </resultMap>


  <select id="customerChecklist" resultMap="OrderCheckDetailMap">
    select concat(o.airport_code,lpad(o.order_id,6,'0')) AS order_no,o.customer_id,o.protocol_id,o.product_id,
    f.flight_date,f.plan_no,f.flight_dep_airport,f.flight_arr_airport,f.is_in_or_out,
    (select os.service_detail ->'$.serverNum' as personNum from order_service os where os.order_id = o.order_id and os.service_detail -> '$.serviceId' = 1) as vip_person_num,
    (select os.price_rule ->'$.price' as price from order_service os where os.order_id = o.order_id and os.service_detail -> '$.serviceId' = 1) as vip_price,

    (select os.service_detail ->'$.serverNum' as personNum from order_service os where os.order_id = o.order_id and os.service_detail -> '$.serviceId' = 3) as accompany_person_num,
    (select os.price_rule ->'$.price' as price from order_service os where os.order_id = o.order_id and os.service_detail -> '$.serviceId' = 3) as accompany_price


    from order_info o
    inner join flight f on f.flight_id = o.flight_id
    <if test="criteria.customerId != null and !''.equals(criteria.customerId)">
      and o.customer_id in (#{criteria.customerIds})
    </if>
    <if test="criteria.productId != null and !''.equals(criteria.productId)">
      and o.product_id in (#{criteria.productId})
    </if>
    <if test="criteria.protocolId != null and !''.equals(criteria.protocolId)">
      and o.protocol_id in (#{criteria.protocolId})
    </if>


  </select>

</mapper>